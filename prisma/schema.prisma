generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id             String        @id @default(uuid())
  name           String
  type           String
  currency       String        @default("USD")
  institution    String
  currentBalance Decimal?      @db.Decimal(12, 2)
  lastSyncedAt   DateTime?
  createdAt      DateTime      @default(now())
  transactions   Transaction[]
}

model Transaction {
  id           String             @id @default(uuid())
  accountId    String
  account      Account            @relation(fields: [accountId], references: [id])
  externalId   String?
  dedupeKey    String             @unique
  amount       Decimal            @db.Decimal(12, 2)
  currency     String             @default("USD")
  description  String
  merchantName String?
  date         DateTime           @db.Date
  timestamp    DateTime?
  category     String?
  aiCategory   String?
  aiConfidence Float?
  status       String             @default("pending")
  reviewedAt   DateTime?
  note         String?
  tags         String[]
  source       String
  rawData      Json?
  createdAt    DateTime           @default(now())
  items        TransactionItem[]
  photos       TransactionPhoto[]

  @@index([accountId])
  @@index([date])
  @@index([category])
  @@index([status])
}

model TransactionItem {
  id            String      @id @default(uuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  name          String
  amount        Decimal     @db.Decimal(12, 2)
  quantity      Int         @default(1)
  category      String?
  extractedFrom String
  createdAt     DateTime    @default(now())

  @@index([transactionId])
}

model TransactionPhoto {
  id              String      @id @default(uuid())
  transactionId   String
  transaction     Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  storagePath     String
  thumbnailPath   String?
  extractedText   String?
  extractedData   Json?
  extractionModel String?
  createdAt       DateTime    @default(now())

  @@index([transactionId])
}

model Category {
  id    String  @id
  name  String
  type  String
  color String?
  icon  String?
}

model Subscription {
  id            String   @id @default(uuid())
  name          String
  amount        Decimal  @db.Decimal(12, 2)
  currency      String   @default("USD")
  billingDay    Int?
  frequency     String   @default("monthly")
  category      String?
  active        Boolean  @default(true)
  lastChargedAt DateTime?
  createdAt     DateTime @default(now())
}

model Goal {
  id            String   @id @default(uuid())
  name          String
  targetAmount  Decimal  @db.Decimal(12, 2)
  currentAmount Decimal  @default(0) @db.Decimal(12, 2)
  targetDate    DateTime?
  createdAt     DateTime @default(now())
}

model MonthlySnapshot {
  id              String   @id @default(uuid())
  month           DateTime @unique @db.Date
  totalUsd        Decimal? @db.Decimal(12, 2)
  totalBrl        Decimal? @db.Decimal(12, 2)
  exchangeRate    Decimal? @db.Decimal(10, 4)
  netWorthUsd     Decimal? @db.Decimal(12, 2)
  accountBalances Json?
  createdAt       DateTime @default(now())
}
